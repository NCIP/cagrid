<?xml version="1.0"?>

<project default="all" name="globus_wsrf_test_unit" basedir=".">
    <description>
        Unit Tests
    </description>

    <!-- 
    Give user a chance to override without editing this file
    (and without typing -D each time it compiles it) 
    -->
    
    <property environment="env"/>
 
    <property file="build.properties"/>
    <property file="${user.home}/build.properties"/>
    
    <property name="env.GLOBUS_LOCATION" value="../../../../install"/>
    <property name="deploy.dir" location="${env.GLOBUS_LOCATION}"/>
    <property name="base.name" value="wsrf_test_unit"/>
    <property name="package.name" value="globus_${base.name}"/>
    <property name="gar.name" value="${package.name}.gar"/>
    <property name="jar.name" value="${base.name}.jar"/>
    <property name="stubs.jar.name" value="${base.name}_stubs.jar"/>
    <property name="build.dir"  location="build"/>
    <property name="build.dest" location="build/classes"/>
    <property name="build.lib.dir" location="build/lib"/>
    <property name="build.packages" location=
        "${deploy.dir}/share/globus_wsrf_common/build-packages.xml"/>
    <property name="build.test" location=
        "${deploy.dir}/share/globus_wsrf_common/build-test.xml"/>
    <property name="build.stubs" location=
        "${deploy.dir}/share/globus_wsrf_tools/build-stubs.xml"/>
    <property name="stubs.dir" location="build/stubs"/>
    <property name="stubs.src" location="build/stubs/src"/>
    <property name="stubs.dest" location="build/stubs/classes"/>
    <property name="schema.src"   location="${deploy.dir}/share/schema"/>
    <property name="schema.dest"  location="${build.dir}/schema"/>
    <property name="java.debug" value="on"/>
    <property name="java.deprecation" value="true"/>

    <property name="garjars.id" value="garjars"/>
    <fileset dir="${build.lib.dir}" id="garjars"/>

    <property name="garetc.id" value="garEtc"/>
    <fileset dir="etc" id="garEtc"/>    

    <property name="garschema.id" value="garschema"/>
    <fileset dir="${schema.dest}" 
        includes="tests/notification/*" 
        id="garschema"/>

    <property name="junit.reports.dir" value="test-reports"/>
    <property name="junit.haltonfailure" value="true"/>
    <property name="junit.timeout" value="900000"/>
    <property name="junit.jvmarg" value="-Dignore" />

    <property name="security.test.client.authz" value="self"/>
    <property name="security.test.authz.identity" value=""/>
    <property name="security.test.enc.cred" value=""/>

    <property name="test.server.url" 
              value="http://localhost:8080/wsrf/services/"/>
    <property name="secure.test.server.url" 
              value="https://localhost:8443/wsrf/services/"/>

    <property name="java.debug" value="true"/>

    <target name="init">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.dest}"/>
        <mkdir dir="${build.lib.dir}"/>

        <mkdir dir="${stubs.dir}"/>
        <mkdir dir="${stubs.src}"/>
        <mkdir dir="${stubs.dest}"/>

        <mkdir dir="${schema.dest}"/>
        <copy toDir="${schema.dest}">
            <fileset dir="${schema.src}" casesensitive="yes">
                <include name="core/tests/basic/**"/>
                <include name="core/tests/notification/**"/>
                <include name="core/tests/security/**"/>
                <include name="core/tests/invalidate/**"/>
                <include name="core/tests/enumeration/**"/>
                <include name="wsrf/**"/>
                <include name="ws/**"/>
            </fileset>
        </copy>

        <available property="stubs.present" type="dir" 
            file="${stubs.src}/org/globus" />
    </target>

    <target name="stubs" unless="stubs.present" depends="init">
        <ant antfile="${build.stubs}" target="generateStubs">
            <property name="source.stubs.dir" 
                location="${schema.dest}/core/tests/basic"/>
            <property name="target.stubs.dir" location="${stubs.src}"/>
            <property name="wsdl.file" 
                value="test_service.wsdl"/>
        </ant>       
        <ant antfile="${build.stubs}" target="generateStubs">
            <property name="source.stubs.dir" 
                location="${schema.dest}/core/tests/notification"/>
            <property name="target.stubs.dir" location="${stubs.src}"/>
            <property name="wsdl.file" 
                value="notification_test_service.wsdl"/>
        </ant>        
        <ant antfile="${build.stubs}" target="generateStubs">
            <property name="source.stubs.dir" 
                location="${schema.dest}/core/tests/notification"/>
            <property name="target.stubs.dir" location="${stubs.src}"/>
            <property name="wsdl.file" 
                value="persistence_test_subscription_manager_service.wsdl"/>
        </ant>        
	<!-- Test service for secure access test -->
        <ant antfile="${build.stubs}" target="generateStubs">
            <property name="source.stubs.dir" 
                location="${schema.dest}/core/tests/security"/>
            <property name="target.stubs.dir" location="${stubs.src}"/>
            <property name="wsdl.file" 
                value="security_test_service.wsdl"/>
        </ant>      
        <!-- Enumeration test service -->
        <ant antfile="${build.stubs}" target="generateStubs">
            <property name="source.stubs.dir"
                location="${schema.dest}/core/tests/enumeration"/>
            <property name="target.stubs.dir" location="${stubs.src}"/>
            <property name="wsdl.file"
                value="enumeration_service.wsdl"/>
        </ant>  
    </target>
    
    <target name="compileStubs" depends="stubs">
        <javac srcdir="${stubs.src}" destdir="${stubs.dest}"
               debug="${java.debug}" deprecation="${java.deprecation}">
            <include name="**/*.java"/>
            <classpath>
                <fileset dir="${deploy.dir}/lib">
                    <include name="*.jar"/>
                    <exclude name="${stubs.jar.name}"/>
                    <exclude name="${jar.name}"/>
                </fileset>
            </classpath>
        </javac>
    </target>

    <target name="compile" depends="compileStubs">
        <javac srcdir="src" destdir="${build.dest}" 
               debug="${java.debug}" deprecation="${java.deprecation}">
            <include name="**/*.java"/>
            <classpath>
                <pathelement location="${stubs.dest}"/>
                <fileset dir="${deploy.dir}/lib">
                    <include name="*.jar"/>
                    <exclude name="${stubs.jar.name}"/>
                    <exclude name="${jar.name}"/>
                </fileset>
            </classpath>
        </javac>
	<copy todir="${build.dest}" >
	      <fileset dir="src" includes="**/*.properties" />
	      <fileset dir="src" includes="**/*.xml" />
              <fileset dir="src" includes="**/*.pem" />
	</copy>
    </target>

    <target name="jar" depends="compile">
        <jar destfile="${build.lib.dir}/${jar.name}" basedir="${build.dest}"/>
    </target>

    <target name="jarStubs" depends="compileStubs">
        <jar destfile="${build.lib.dir}/${stubs.jar.name}" 
            basedir="${stubs.dest}"/>
    </target>

    <target name="dist" depends="jar, jarStubs">
        <ant antfile="${build.packages}" target="makeGar">
            <reference refid="${garjars.id}"/>  
            <reference refid="${garetc.id}"/>
            <reference refid="${garschema.id}"/>  
        </ant>
    </target>

    <target name="clean">
        <delete dir="tmp"/>
        <delete dir="${build.dir}"/>
        <delete file="${gar.name}"/>
        <delete dir="${junit.reports.dir}"/>
    </target>

    <target name="deploy" depends="dist">
        <ant antfile="${build.packages}" target="deployGar"/>
    </target>  

    <target name="undeploy">
        <ant antfile="${build.packages}" target="undeployGar">
            <property name="gar.id" value="${package.name}"/>
        </ant>
    </target>

    <target name="all" depends="jar"/>

    <target name="test" depends="compile">
      <property name="server.arg" value="-Dignore" />
      <antcall target="runTests"/>
      <antcall target="runSecurityTests"/>
    </target>

    <target name="testServer" depends="compile">
      <property name="server.arg" 
                value="-Dweb.server.url=${test.server.url} -Dsecure.web.server.url=${secure.test.server.url}" />
      <antcall target="runTests"/>
      <antcall target="runSecurityTests"/>
    </target>

    <target name="runTests" unless="securityTestsOnly">
      <mkdir dir="${junit.reports.dir}" />
      <junit printsummary="yes" 
             haltonfailure="${junit.haltonfailure}" 
             fork="yes" 
             timeout="${junit.timeout}">
            <sysproperty key="org.globus.wsrf.container.webroot" 
                value="${deploy.dir}"/>
            <sysproperty key="GLOBUS_LOCATION"
                value="${deploy.dir}"/>
            <classpath>
                <pathelement location="${build.dest}"/>
                <pathelement location="${stubs.dest}"/>
                <pathelement location="${deploy.dir}"/>
                <fileset dir="${deploy.dir}/lib">
                    <include name="*.jar"/>
                    <exclude name="${stubs.jar.name}"/>
                    <exclude name="${jar.name}"/>
                </fileset>
            </classpath>
        <formatter type="xml" />
        <batchtest todir="${junit.reports.dir}">
         <fileset dir="${build.dest}">
            <include name="**/PackageTests.class" />
         </fileset>
        </batchtest>
        <jvmarg value="-Djava.endorsed.dirs=${deploy.dir}/endorsed"/>
        <jvmarg line="${server.arg}" />
        <jvmarg line="${junit.jvmarg}" />
      </junit>
    </target>
    
    <!-- These are security tests. They require valid credentials. -->
    <!-- Using "SecurityTests" as the required class name -->
    <target name="runSecurityTests" unless="basicTestsOnly">
      <mkdir dir="${junit.reports.dir}" />
      <junit printsummary="yes" 
             haltonfailure="${junit.haltonfailure}" 
             fork="yes" 
             timeout="${junit.timeout}">
            <sysproperty key="org.globus.wsrf.container.webroot" 
                value="${deploy.dir}"/>
            <sysproperty key="GLOBUS_LOCATION" 
                value="${deploy.dir}"/>
            <sysproperty key="TEST_CLIENT_AUTHZ" 
                value="${security.test.client.authz}"/>
            <sysproperty key="TEST_CLIENT_ENCRYPTION_CRED" 
                value="${security.test.enc.cred}"/>
            <sysproperty key="TEST_AUTHZ_SERVICE_IDENTITY" 
                value="${security.test.authz.identity}"/>
            <classpath>
                <pathelement location="${build.dest}"/>
                <pathelement location="${stubs.dest}"/>
                <pathelement location="${deploy.dir}"/>
                <fileset dir="${deploy.dir}/lib">
                    <include name="*.jar"/>
                    <exclude name="${stubs.jar.name}"/>
                    <exclude name="${jar.name}"/>
                </fileset>
            </classpath>
        <formatter type="xml" />
        <batchtest todir="${junit.reports.dir}">
         <fileset dir="${build.dest}">
            <include  name="**/SecurityTests.class"/>
         </fileset>
        </batchtest>
        <jvmarg value="-Djava.endorsed.dirs=${deploy.dir}/endorsed"/>
        <jvmarg line="${server.arg}" />
        <jvmarg line="${junit.jvmarg}" />
      </junit>
    </target>

</project>
