<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">


    <changeSet id="1" author="kherm">
        <tagDatabase tag="version_2.1"/>
    </changeSet>

    <changeSet id="2" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="status_change" columnName="archived"/>
            </not>
        </preConditions>
        <addColumn tableName="status_change">
            <column name="archived" type="bit">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="3" author="kherm">
        <tagDatabase tag="version_2.2"/>
    </changeSet>

    <changeSet id="4" author="kherm">
        <modifyColumn tableName="c_hier_node">
            <column name="description" type="text"/>
        </modifyColumn>
    </changeSet>

    <changeSet id="5" author="kherm">
        <modifyColumn tableName="query_instances">
            <column name="error" type="text"/>
        </modifyColumn>
    </changeSet>

    <changeSet id="6" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notification_subscriber"/>
            </not>
        </preConditions>
        <createTable tableName="notification_subscriber">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="int">
                <constraints references="portal_users(id)" foreignKeyName="FK345D683C9B17579D"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="7" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notification_subscriptions"/>
            </not>
        </preConditions>
        <createTable tableName="notification_subscriptions">
            <column name="id" type="int" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="statusesContainer" type="varchar(255)"/>
            <column name="subscriber_id" type="int">
                <constraints references="notification_subscriber(id)" foreignKeyName="FKDA99AEA24F1130BC"/>
            </column>
            <column name="service_id" type="int">
                <constraints references="grid_services(id)" foreignKeyName="FKDA99AEA26E4B3B1D"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="8" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="portal_users" columnName="delegatedEPR"/>
            </not>
        </preConditions>
        <addColumn tableName="portal_users">
            <column name="delegatedEPR" type="text">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="9" author="kherm">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="notification_subscriptions" columnName="statusesContainer"/>
        </preConditions>
        <dropColumn tableName="notification_subscriptions" columnName="statusesContainer"/>
    </changeSet>

    <changeSet id="10" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="notification_subscriber" columnName="haltSubscriptions"/>
            </not>
        </preConditions>
        <addColumn tableName="notification_subscriber">
            <column name="haltSubscriptions" type="bit" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>


    <changeSet id="11" author="kherm">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="notification_log"/>
            </not>
        </preConditions>
        <createTable tableName="notification_log">
            <column name="id" type="integer" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="notificationType" type="varchar(255)"/>
            <column name="sendSuccessful" type="bit"/>
            <column name="timestamp" type="datetime"/>
            <column name="subscriber_id" type="integer">
                <constraints references="notification_subscriber(id)" foreignKeyName="FKDA99AEA26E4B3B1D"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
