<?xml version="1.0"?>
<project name="caGrid-sdk42StyleTests" default="all" basedir=".">
	<property environment="env" />
	<property file="build.properties" />
	<property file="project.properties" />
	<property name="globus.dir" location="${env.GLOBUS_LOCATION}" />
	
	<!-- locations within the testing project -->
	<property name="project.name" value="${ant.project.name}" />
	<property name="src.dir" value="${basedir}/src" />
	<property name="resources.dir" value="resources" />
	<property name="build.dir" value="${basedir}/build" />
	<property name="classes.dir" value="${build.dir}/classes" />
	<property name="jar.dir" value="${build.dir}/lib" />
	<property name="project.jarfile" value="${jar.dir}/${project.name}-${project.version}.jar" />
	<property name="resources.jarfile" value="${jar.dir}/${project.name}-resources-${project.version}.jar" />
	<property name="ext.lib.dir" location="${basedir}/ext/dependencies/jars" />
	<property name="ext.resources.dir" location="${basedir}/ext/dependencies/resources"/>
	
	<!-- dependencies on SDK -->
	<property name="sdk.zip" location="${ext.resources.dir}/sdk/caCORE_SDK_42.zip"/>
	<property name="example.project.zip" location="${ext.resources.dir}/sdk/sdk42-example-trimmed.zip"/>
	<property name="sdk.unpack.dir" location="${build.dir}/cacore/sdk"/>
	<property name="example.project.unpack.dir" location="${build.dir}/cacore/example"/>
	<property name="sdk.application.name" value="example42"/>
	
	<!-- dependency on SDK 4.2 data service style -->
	<property name="style.zip.location" location="${ext.resources.dir}/style/caGrid-sdkQuery42-package.zip"/>
	
	<!-- depends on Introduce toolkit -->
	<property name="introduce.dir" location="${basedir}/../../../caGrid/projects/introduce" />
	
	<!-- output directory for JUnit logs -->
	<property name="junit.results.dir" location="${basedir}/log/junit" />

	<!-- build with debugging information -->
	<property name="java.debug" value="on" />
	
	<!-- enforce java 1.5 compliance at build time -->
	<property name="java.source" value="1.5" />
	
	<!-- import the tests -->
	<import file="test.xml"/>
	

	<!-- =============================================================== -->
	<!-- Prepares the classpaths                                         -->
	<!-- =============================================================== -->
	<target name="defineClasspaths">
		<path id="build.classpath">
			<!-- this is kinda funny to make sure the testUtils jars get in ahead of the old testing stuff -->
			<fileset dir="${ext.lib.dir}">
				<include name="**/*.jar" />
				<exclude name="**/*testing-system*.jar"/>
			</fileset>
			<fileset dir="${ext.lib.dir}">
				<include name="**/*testing-system*.jar"/>
			</fileset>
			<fileset dir="${globus.dir}/lib">
				<include name="**/*.jar" />
                <exclude name="junit.jar"/>
			</fileset>
			<pathelement location="${globus.dir}" />
		</path>
		
		<path id="Introduce.test.classpath">
			<fileset dir="${introduce.dir}/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${introduce.dir}/ext/dependencies/jars">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${introduce.dir}/build/jars">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${introduce.dir}/test/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${introduce.dir}/ext/dependencies/test/jars">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${ant.library.dir}">
				<include name="*.jar" />
			</fileset>
		    <pathelement path="${introduce.dir}/test/resources"/>
		</path>
	
		<path id="test.run.classpath">
			<path refid="build.classpath"/>
			<path refid="Introduce.test.classpath"/>
			<fileset dir="${example.project.unpack.dir}/example-project/target/dist/exploded/output/example/package/local-client/lib">
				<include name="*-beans.jar"/>
			</fileset>
		</path>
	</target>

	
	<!-- =============================================================== -->
	<!-- Prepares the build directory                                    -->
	<!-- =============================================================== -->
	<target name="prepare" depends="defineClasspaths">
		<tstamp />
		<mkdir dir="${build.dir}"/>
		<mkdir dir="${classes.dir}"/>
		<mkdir dir="${jar.dir}"/>
		<antcall target="unpackSdk"/>
	</target>
	
	
	<!-- unpacks the caCORE SDK -->
	<target name="unpackSdk">
		<delete dir="${sdk.unpack.dir}"/>
		<delete dir="${example.project.unpack.dir}"/>
		<unzip src="${sdk.zip}" dest="${sdk.unpack.dir}"/>
		<unzip src="${example.project.zip}" dest="${example.project.unpack.dir}"/>
	</target>
	

	<!-- =============================================================== -->
	<!-- Compiles the source code                                        -->
	<!-- =============================================================== -->
	<target name="compile" depends="prepare" description="compiles.">
		<!-- test source -->
		<javac srcdir="${src.dir}" destdir="${classes.dir}" source="${java.source}" target="${java.source}" debug="${java.debug}" memoryinitialsize="256m" memorymaximumsize="1024m" fork="true">
			<classpath refid="build.classpath" />
		</javac>
	</target>


	<!-- ============================================================== -->
	<!-- Cleans up generated stuff                                      -->
	<!-- ============================================================== -->
	<target name="clean" depends="" description="Removes generated files.">
		<delete dir="${build.dir}" />
	</target>


	<!-- ============================================================== -->
	<!-- Creates the jar files                                          -->
	<!-- ============================================================== -->
	<target name="jar" depends="compile" description="Builds the Jar Files">
		<mkdir dir="${jar.dir}" />
		<jar destfile="${project.jarfile}">
			<fileset dir="${classes.dir}">
				<include name="**/*.class"/>
			</fileset>
			<fileset dir="${src.dir}">
				<include name="**/*"/>
			</fileset>
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
			</manifest>
		</jar>
		<jar destfile="${resources.jarfile}">
			<fileset dir="${basedir}">
				<include name="${resources.dir}/**/*"/>
			</fileset>
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
			</manifest>
		</jar>
	</target>


	<!-- ============================================================== -->
	<!-- Builds everything                                              -->
	<!-- ============================================================== -->
	<target name="all" description="Builds the entire application" depends="compile, jar"/>
</project>

